(file content from above - the complete 988-line main.py)